<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡®è®¤è¡¨å• - AIåŠ©æ‰‹</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        h1 { color: #333; border-bottom: 2px solid #007AFF; padding-bottom: 10px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
        .question {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .question-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .question-number {
            background: #007AFF; color: white; width: 32px; height: 32px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; flex-shrink: 0;
        }
        .question-title { margin: 0; color: #333; font-size: 18px; }
        .section {
            background: #f8f9fa; border-left: 3px solid #dee2e6;
            padding: 12px 16px; margin: 12px 0; border-radius: 0 8px 8px 0;
        }
        .section.context { border-left-color: #6c757d; }
        .section.uncertainty { border-left-color: #ffc107; background: #fff9e6; }
        .section.findings { border-left-color: #17a2b8; background: #e8f7fa; }
        .section.judgment { border-left-color: #28a745; background: #e8f5e9; }
        .section-label { font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; margin-bottom: 6px; }
        .section p { margin: 0; color: #333; }
        .findings-list { margin: 8px 0 0 0; padding-left: 20px; }
        .findings-list li { margin: 6px 0; color: #333; }
        .findings-list .source { color: #666; font-size: 13px; }
        .options { margin-top: 16px; border-top: 1px solid #eee; padding-top: 16px; }
        .options-label { font-weight: 600; color: #333; margin-bottom: 12px; }
        .option-item {
            display: block; padding: 14px 16px; margin: 8px 0;
            background: #f8f8f8; border: 2px solid transparent;
            border-radius: 10px; cursor: pointer; transition: all 0.2s;
        }
        .option-item:hover { background: #e8f4ff; border-color: #007AFF; }
        .option-item.selected { background: #e8f4ff; border-color: #007AFF; }
        .option-item input[type="radio"] { margin-right: 12px; transform: scale(1.2); }
        .option-label { font-weight: 500; color: #333; }
        .option-basis { display: block; margin-top: 6px; margin-left: 28px; font-size: 13px; color: #666; }
        .custom-section { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ddd; }
        .custom-input {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 8px; font-size: 14px; resize: vertical;
        }
        .custom-input:focus { outline: none; border-color: #007AFF; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .global-section {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 1px solid #ffc107;
        }
        .global-section h3 { color: #856404; margin-top: 0; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
        .btn-group button {
            padding: 12px 20px; border: 2px solid #ddd; border-radius: 10px;
            background: white; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .btn-group button:hover { background: #007AFF; color: white; border-color: #007AFF; }
        .btn-group button.active { background: #007AFF; color: white; border-color: #007AFF; }
        #submitBtn {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 18px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }
        #submitBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,122,255,0.4); }
        #submitBtn:disabled { background: #ccc; transform: none; box-shadow: none; cursor: not-allowed; }
        #result {
            display: none;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px; padding: 24px; margin-top: 24px; border: 1px solid #28a745;
            text-align: center;
        }
        #result h3 { color: #155724; margin-top: 0; }
        #result p { color: #155724; font-size: 16px; }
        .status { padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; display: none; }
        .status.loading { background: #cce5ff; color: #004085; display: block; }
        .status.success { background: #d4edda; color: #155724; display: block; }
        .status.error { background: #f8d7da; color: #721c24; display: block; }
    </style>
</head>
<body>
    <h1>ğŸ“‹ AIåŠ©æ‰‹çš„ç¡®è®¤è¡¨å•</h1>
    <p class="meta">ç”Ÿæˆæ—¶é—´ï¼š{{TIMESTAMP}} | å…± {{QUESTION_COUNT}} ä¸ªé—®é¢˜</p>
    <p style="color:#666;">æˆ‘æ•´ç†äº†ä»¥ä¸‹é—®é¢˜éœ€è¦ä¸»äººç¡®è®¤ã€‚å¡«å®Œç‚¹æäº¤ï¼Œæˆ‘ä¼šè‡ªåŠ¨æ”¶åˆ°é€šçŸ¥ã€‚</p>
    
    <div id="questions"></div>
    
    <div class="global-section">
        <h3>ğŸ’¬ æ•´ä½“åé¦ˆ</h3>
        <div class="btn-group">
            <button type="button" onclick="setGlobalFeedback(this, 'all_ok')">âœ… å…¨éƒ¨åŒæ„æˆ‘çš„åˆ¤æ–­</button>
            <button type="button" onclick="setGlobalFeedback(this, 'need_more_info')">ğŸ“„ éœ€è¦è¡¥å……ææ–™</button>
            <button type="button" onclick="setGlobalFeedback(this, 'discuss')">ğŸ’­ éœ€è¦è®¨è®º</button>
        </div>
        <textarea id="globalComment" class="custom-input" rows="3" placeholder="æ•´ä½“æ„è§æˆ–è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
    </div>
    
    <button id="submitBtn" onclick="submitForm()">ğŸ“¤ æäº¤å¹¶é€šçŸ¥AIåŠ©æ‰‹</button>
    <div id="statusDiv" class="status"></div>
    
    <div id="result">
        <h3>âœ… å·²æäº¤ï¼</h3>
        <p>AIåŠ©æ‰‹å·²æ”¶åˆ°é€šçŸ¥ï¼Œç¨åä¼šå›å¤ä½ ã€‚</p>
        <p style="font-size: 14px; color: #666;">ä½ å¯ä»¥å…³é—­è¿™ä¸ªé¡µé¢äº†ã€‚</p>
    </div>

    <script>
        const CONFIG = {
            formId: "{{FORM_ID}}",
            notifyTopic: "{{NOTIFY_TOPIC}}",
            questions: {{QUESTIONS_JSON}}
        };
        
        let globalFeedback = null;
        
        function initQuestions() {
            const container = document.getElementById('questions');
            CONFIG.questions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'question';
                
                let findingsHtml = '';
                if (q.findings && q.findings.length) {
                    findingsHtml = `
                        <div class="section findings">
                            <div class="section-label">ğŸ” æˆ‘å‘ç°çš„ä¿¡æ¯</div>
                            <ul class="findings-list">
                                ${q.findings.map(f => `<li><strong>${f.content}</strong><span class="source">â€” ${f.source}</span></li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">${idx + 1}</div>
                        <h3 class="question-title">${q.title}</h3>
                    </div>
                    ${q.context ? `<div class="section context"><div class="section-label">ğŸ“– èƒŒæ™¯</div><p>${q.context}</p></div>` : ''}
                    ${q.uncertainty ? `<div class="section uncertainty"><div class="section-label">â“ æˆ‘ä¸ç¡®å®šçš„ç‚¹</div><p>${q.uncertainty}</p></div>` : ''}
                    ${findingsHtml}
                    ${q.judgment ? `<div class="section judgment"><div class="section-label">ğŸ’­ æˆ‘çš„åˆ¤æ–­</div><p>${q.judgment}</p></div>` : ''}
                    <div class="options">
                        <div class="options-label">ğŸ“‹ è¯·é€‰æ‹©ï¼š</div>
                        ${q.options.map((opt, optIdx) => `
                            <label class="option-item" onclick="selectOption(this, ${idx})">
                                <input type="radio" name="q${idx}" value="${optIdx}">
                                <span class="option-label">${opt.label}</span>
                                ${opt.basis ? `<span class="option-basis">${opt.basis}</span>` : ''}
                            </label>
                        `).join('')}
                        <div class="custom-section">
                            <input type="text" class="custom-input" id="custom${idx}" placeholder="æˆ–è¾“å…¥å…¶ä»–æ„è§...">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function selectOption(label, qIdx) {
            document.querySelectorAll(`input[name="q${qIdx}"]`).forEach(input => {
                input.closest('.option-item').classList.remove('selected');
            });
            label.classList.add('selected');
        }
        
        function setGlobalFeedback(btn, type) {
            globalFeedback = type;
            document.querySelectorAll('.global-section .btn-group button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        async function submitForm() {
            const btn = document.getElementById('submitBtn');
            const statusDiv = document.getElementById('statusDiv');
            
            btn.disabled = true;
            btn.textContent = 'â³ æ­£åœ¨æäº¤...';
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'æ­£åœ¨é€šçŸ¥AIåŠ©æ‰‹...';
            
            const answers = CONFIG.questions.map((q, idx) => {
                const selected = document.querySelector(`input[name="q${idx}"]:checked`);
                const custom = document.getElementById(`custom${idx}`).value.trim();
                return {
                    question: q.title,
                    myJudgment: q.judgment || null,
                    selectedOption: selected ? parseInt(selected.value) : null,
                    selectedLabel: selected ? q.options[parseInt(selected.value)].label : null,
                    customAnswer: custom || null,
                    agreedWithMyJudgment: selected && q.options[parseInt(selected.value)].basis?.includes('æˆ‘çš„æ¨è')
                };
            });
            
            const result = {
                formId: CONFIG.formId,
                timestamp: new Date().toISOString(),
                globalFeedback: globalFeedback,
                globalComment: document.getElementById('globalComment').value.trim() || null,
                summary: {
                    total: answers.length,
                    answered: answers.filter(a => a.selectedOption !== null || a.customAnswer).length,
                    agreedWithAI: answers.filter(a => a.agreedWithMyJudgment).length
                },
                answers: answers
            };
            
            try {
                // å‘é€åˆ° ntfy.sh
                const response = await fetch(`https://ntfy.sh/${CONFIG.notifyTopic}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(result)
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… å·²é€šçŸ¥AIåŠ©æ‰‹ï¼';
                document.getElementById('result').style.display = 'block';
                btn.textContent = 'âœ… å·²æäº¤';
                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                
            } catch (err) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ é€šçŸ¥å¤±è´¥: ${err.message}ï¼Œè¯·å¤åˆ¶ç»“æœæ‰‹åŠ¨å‘é€`;
                btn.disabled = false;
                btn.textContent = 'ğŸ“¤ é‡è¯•';
                
                // é™çº§ï¼šæ˜¾ç¤ºç»“æœè®©ç”¨æˆ·å¤åˆ¶
                const fallback = document.createElement('div');
                fallback.innerHTML = `
                    <details style="margin-top:15px">
                        <summary>ç‚¹å‡»å¤åˆ¶ç»“æœ</summary>
                        <textarea style="width:100%;height:200px;margin-top:10px">${JSON.stringify(result, null, 2)}</textarea>
                    </details>
                `;
                statusDiv.parentNode.insertBefore(fallback, statusDiv.nextSibling);
            }
        }
        
        initQuestions();
    </script>
</body>
</html>
