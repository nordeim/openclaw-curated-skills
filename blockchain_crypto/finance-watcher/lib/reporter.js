class Reporter {
  constructor(config) {
    this.config = config;
  }

  async generate(cryptoAPI, stockAPI) {
    const date = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long'
    });

    let report = `# ğŸ“Š æŠ•èµ„ç»„åˆæ—¥æŠ¥\n\n`;
    report += `**ç”Ÿæˆæ—¶é—´**: ${date}  \n`;
    report += `**è´§å¸**: ${this.config.currency || 'USD'}  \n\n`;
    report += `---\n\n`;

    // Crypto section
    if (this.config.watchlist.crypto?.length > 0) {
      report += `## ğŸ’ åŠ å¯†è´§å¸\n\n`;
      
      for (const symbol of this.config.watchlist.crypto) {
        try {
          const data = await cryptoAPI.getPrice(symbol.toLowerCase());
          const price = data?.usd || 'N/A';
          const change24h = data?.usd_24h_change;
          
          report += `### ${symbol.toUpperCase()}\n`;
          report += `- **ä»·æ ¼**: $${price.toLocaleString()}\n`;
          if (change24h !== undefined) {
            const emoji = change24h >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
            report += `- **24h å˜åŒ–**: ${emoji} ${change24h > 0 ? '+' : ''}${change24h.toFixed(2)}%\n`;
          }
          report += `\n`;
        } catch (e) {
          report += `### ${symbol.toUpperCase()}\n- æ•°æ®è·å–å¤±è´¥\n\n`;
        }
      }
    }

    // Stock section
    if (this.config.watchlist.stocks?.length > 0) {
      report += `## ğŸ“ˆ è‚¡ç¥¨\n\n`;
      
      for (const symbol of this.config.watchlist.stocks) {
        try {
          const data = await stockAPI.getQuote(symbol);
          const emoji = data.change >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
          
          report += `### ${symbol}\n`;
          report += `- **ä»·æ ¼**: $${data.price.toLocaleString()}\n`;
          report += `- **æ¶¨è·Œ**: ${emoji} $${data.change > 0 ? '+' : ''}${data.change.toFixed(2)} (${data.changePercent > 0 ? '+' : ''}${data.changePercent.toFixed(2)}%)\n`;
          report += `- **è´§å¸**: ${data.currency}\n\n`;
        } catch (e) {
          report += `### ${symbol}\n- æ•°æ®è·å–å¤±è´¥\n\n`;
        }
      }
    }

    // Active alerts
    if (this.config.alerts?.length > 0) {
      report += `## ğŸ”” æ´»è·ƒè­¦æŠ¥\n\n`;
      const activeAlerts = this.config.alerts.filter(a => !a.triggered);
      
      if (activeAlerts.length === 0) {
        report += `æš‚æ— æ´»è·ƒè­¦æŠ¥\n\n`;
      } else {
        activeAlerts.forEach(alert => {
          report += `- **${alert.symbol}**: `;
          if (alert.above) report += `çªç ´ $${alert.above.toLocaleString()}`;
          if (alert.below) report += `è·Œç ´ $${alert.below.toLocaleString()}`;
          if (alert.percent) report += `æ³¢åŠ¨è¶…è¿‡ ${alert.percent}%`;
          report += `\n`;
        });
        report += `\n`;
      }
    }

    report += `---\n\n`;
    report += `*Generated by Finance Watcher*  \n`;
    report += `*Data from CoinGecko & Yahoo Finance*  \n`;
    report += `*Powered by OpenClaw* ğŸ¾`;

    return report;
  }
}

module.exports = Reporter;
