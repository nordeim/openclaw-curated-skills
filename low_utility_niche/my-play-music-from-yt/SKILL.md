---
name: my-play-music-from-yt
description: |
  Play music on YouTube via browser automation with playwright-cli.
  Use when the user wants to: 
  (1) play a specific song (e.g. 'play Money Money Money by ABBA') 
  (2) play songs by an artist as a playlist or mix (e.g. 'play Jay Chou's songs') 
  (3) play genre or mood-based music (e.g. 'play relaxing spa music', 'play 60s Chinese oldies') 
  (4) control playback â€” next, pause, resume, stop, skip ad, change song, close the player. 
  Also handles song/artist name corrections from voice transcription errors.
allowed-tools: Bash(playwright-cli:*)
metadata: {"openclaw": {"requires": {"bins": ["playwright-cli"]}, "emoji": "ğŸµ"}}
---

# Play Music from YouTube â€” Clear, Stable, High SNR Instruction Set

This skill controls a **visible browser** using `playwright-cli` to search and play YouTube music.
All actions follow **snapshot â†’ ref â†’ action** pattern. Never guess. Never assume.

---
# CORE PRINCIPLES

### **1. Always use a named session**
```
-s=music_player
```
Every command must include it.

### **2. Always snapshot before interacting**
```
playwright-cli -s=music_player snapshot
```
Never click/fill without fresh refs.

### **3. Only use ref-based actions**
```
click e123
fill e45 "text"
```
Never use CSS, XPaths, or assumptions.

### **4. Browser must be visible**
```
--headed
```
Use headed **by default** unless the user explicitly requests headless.

### **5. Session continues in background**
After playback begins, do not block waiting. Continue responding normally.

### **6. Use persistent browser profile**
```
--persistent
```
Always include `--persistent` when opening a new session. This saves the browser profile (cookies, localStorage, IndexedDB, cache) to disk, so **login state survives session restarts**.

---
# SNAPSHOT STORAGE

Snapshots generated by `playwright-cli` may exist in two possible locations:

1. `$WORKSPACE/.playwright-cli/` â† **primary (search here first)**
2. `~/.playwright-cli/` â† **fallback when the workspace folder is empty**

Use **only these two folders** unless the user explicitly authorizes a broader search.

If no .yml snapshots appear here, it is almost always **MacOS permission-related**.
Ask the user to run:
```
playwright-cli open https://www.youtube.com --headed
```
This will trigger macOS system dialogs for:
- Screen Recording
- Automation
- Accessibility

Approve all to enable snapshot generation.

> **Note:** On Windows and Linux, these permission dialogs do not apply. If snapshots are missing on those platforms, check that the browser launched correctly.

---
# SESSION MANAGEMENT

### Check whether the session exists
```
playwright-cli list
```
- Exists â†’ continue
- Missing â†’ recreate:
```
playwright-cli -s=music_player open https://www.youtube.com --headed --persistent
```

**On any unexpected error**, run `playwright-cli list` first to diagnose before retrying.

### If the session is frozen or blank
```
playwright-cli -s=music_player goto https://www.youtube.com
```
This reliably resets the page without closing the session.

---
# SEARCH QUERY CONSTRUCTION

Build the search query based on user intent:

| Intent | Query pattern | Example |
|---|---|---|
| Specific song | `[Artist] [Song Title]` | `ABBA Money Money Money` |
| Artist playlist | `[Artist]` | `å‘¨æ°å€«` |
| Genre / mood | `[descriptor] music playlist` | `relaxing spa music playlist` |
| Era-based | `[era] [language/genre] playlist` | `è¯èª 60å¹´ä»£ è€æ­Œ playlist` |

**Search tips:**
- For artist requests, a simple artist name search usually surfaces "Mix" and playlist results at the top â€” prefer these for continuous playback.
- Use the original language for non-English songs (e.g. Chinese characters for Chinese songs).

**Voice transcription (ASR) and typo handling:**
- **Do NOT ask the user to confirm** potentially misheard names. YouTube has robust auto-correction and will show results for the intended query even with typos or homophones (e.g. searching "æ¥Šæˆæ—" will auto-correct to "æ¥Šä¸ç³").
- Always search directly with whatever text you have. After the search, check the results snapshot â€” if YouTube shows a "Did you mean: ..." or "é¡¯ç¤ºä»¥ä¸‹æœå°‹çµæœ: ..." banner with corrected results, the correction is already applied.
- Only fall back to **web search** or asking the user if the YouTube search results are clearly unrelated or empty.

---
# SEARCH WORKFLOW (HIGH SIGNAL, LOW AMBIGUITY)

## **Step 1 â€” Reset search state**
A clean search state avoids dropdown obstruction.

Perform the following every time before a new search:

1. Snapshot.
2. If button `"Clear search query"` / `"æ¸…é™¤æœå°‹æŸ¥è©¢"` is present â†’ click it.
3. Else press:
```
playwright-cli -s=music_player press Escape
```
4. If suggestions or overlays still block results â†’ reset page:
```
playwright-cli -s=music_player goto https://www.youtube.com
```
Then snapshot again.

---
## **Step 2 â€” Locate search bar**
Snapshot â†’ find:
- `combobox "æœå°‹"` or
- `combobox "Search"`

Record its ref (e.g., `e34`).

---
## **Step 3 â€” Perform search**
```
playwright-cli -s=music_player fill <searchRef> "SEARCH TERM"
playwright-cli -s=music_player press Enter
```
Then snapshot immediately to avoid suggestion-panel obstruction.

---
## **Step 4 â€” Choose best result**

Select result based on **user intent**:

- **Specific song** â†’ click the `link` whose heading matches the song title.
- **Artist** â†’ prefer `"Mix - [Artist]"` links or playlist links for continuous playback.
- **Genre / mood** â†’ prefer long-duration compilations or playlists (>20 mins).
- **Fallback** if no clear match â†’ prefer: Mix > Long playlist > Official channel upload > Single MV.

For guidance on identifying YouTube result types, see [./references/youtube-guide.md](./references/youtube-guide.md).

**Important:** Do NOT click channel cards (e.g. `link "Artist Name ... @handleâ€¢NNNK subscribers ..."` / `"Artist Name ... @handleâ€¢NNNè¬ä½è¨‚é–±è€… ..."`). They navigate to the channel page, not music. Look for Mix or playlist results below them.

Click using its ref:
```
playwright-cli -s=music_player click eXYZ
```

If click is blocked:
1. `press Escape`
2. Retry click once.
3. If still blocked â†’ `goto https://www.youtube.com` and restart from Step 1.

---
# AD HANDLING LOOP

After clicking a result:
```
playwright-cli -s=music_player snapshot
```
Loop up to 4 iterations:

### **1. Playback detected**
If you see:
- `button "Pause (k)"` or
- `button "Play (k)"` (but video advancing)

AND no ad indicators â†’ playback is active â†’ report song title to the user.

### **2. Skip button detected**
Any element whose label contains:
- skip / Skip / ç•¥é
- Skip Ad / Skip Ads / ç•¥éå»£å‘Š

â†’ click it immediately.

**Note:** If the skip button is `[disabled]` (countdown not yet elapsed), do NOT click it â€” wait ~5 seconds instead (see step 3).

Then snapshot again. YouTube often plays **two consecutive ads** â€” always check for a second ad after skipping.

### **3. Non-skippable ad / countdown**
Wait 5 seconds:
```
playwright-cli -s=music_player eval "await new Promise(r=>setTimeout(r,5000))"
```
Then snapshot again and repeat from step 1.

### If ads persist >20 seconds
- press Escape
- or reload page

---
# PLAYBACK CONTROLS
Always snapshot first.

| Command | Action |
|--------|--------|
| Pause | click `button "Pause (k)"` |
| Resume / Play | click `button "Play (k)"` |
| Next | `press Shift+n` |
| Previous | `press Shift+p` |
| Change song | Start new search from Step 1 |
| Stop | `playwright-cli -s=music_player close` |

**Keyboard shortcuts** (reliable alternative when button refs are hard to locate):

```
k        â†’ play / pause
Shift+n  â†’ next track
Shift+p  â†’ previous track
m        â†’ mute / unmute
f        â†’ fullscreen toggle
j        â†’ rewind 10s
l        â†’ forward 10s
```

Usage: `playwright-cli -s=music_player press <key>`

---
# ERROR RECOVERY & EDGE CASES

### If snapshot empty or missing critical refs
```
playwright-cli -s=music_player goto https://www.youtube.com
```
â†’ restart from Step 1.

### If browser crashes or session disappears
`playwright-cli list` shows no `music_player`.
Inform the user the browser was closed, then recreate session:
```
playwright-cli -s=music_player open https://www.youtube.com --headed --persistent
```
Because `--persistent` is used, the browser profile (including login state) is restored automatically. No need to log in again.

### YouTube cookie consent / sign-in dialogs
Snapshot â†’ locate dismiss actions:
- "Accept all" / "å…¨éƒ¨æ¥å—"
- "Reject all"
- "No thanks" / "ä¸ç”¨äº†ï¼Œè¬è¬"
- Close (X)

Click dismiss.

### YouTube Premium trial popup
Snapshot â†’ look for `"No thanks"`, `"ä¸ç”¨äº†ï¼Œè¬è¬"`, or a dismiss/close button â†’ click to dismiss.

### Video unavailable
Snapshot shows "Video unavailable" or similar error.
- `playwright-cli -s=music_player go-back` â†’ snapshot â†’ try the next result link.

### Cannot find elements in search results
- Scroll down: `playwright-cli -s=music_player press PageDown` â†’ snapshot again.

### Page frozen or blank
- `playwright-cli -s=music_player reload` â†’ snapshot.
- If still broken: `playwright-cli -s=music_player close` â†’ reopen and retry from Step 1.

### Persistent profile corrupted or login expired
If the browser opens but login state is lost, or YouTube forces re-authentication:
1. Inform the user they need to log in again in the browser.
2. After login, the persistent profile will be updated automatically.

To completely reset the profile (last resort):
```
playwright-cli -s=music_player close
playwright-cli -s=music_player delete-data
playwright-cli -s=music_player open https://www.youtube.com --headed --persistent
```

---
# REFERENCES
- [Playwright CLI reference](./references/playwright-ref.md)
- [YouTube result identification](./references/youtube-guide.md)
