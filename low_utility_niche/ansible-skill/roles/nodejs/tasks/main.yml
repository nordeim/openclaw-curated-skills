---
# Node.js role - Install via NodeSource

- name: Ensure keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  tags: [nodejs]

- name: Install NodeSource GPG key
  ansible.builtin.shell: |
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  args:
    creates: /etc/apt/keyrings/nodesource.gpg
  tags: [nodejs]

- name: Add NodeSource repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_version }}.x nodistro main"
    state: present
    filename: nodesource
  tags: [nodejs]

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: yes
  tags: [nodejs]

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: nodejs_installed_version
  changed_when: false
  tags: [nodejs]

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js {{ nodejs_installed_version.stdout }} installed"
  tags: [nodejs]

# === Global npm packages ===
- name: Install global npm packages
  community.general.npm:
    name: "{{ item.name | default(item) }}"
    version: "{{ item.version | default(omit) }}"
    global: yes
    state: present
  loop: "{{ nodejs_npm_global_packages | default([]) }}"
  when: nodejs_npm_global_packages | default([]) | length > 0
  tags: [nodejs, npm]

# === PM2 Process Manager (optional) ===
- name: Install PM2
  community.general.npm:
    name: pm2
    global: yes
    state: present
  when: nodejs_pm2_enabled | default(false) | bool
  tags: [nodejs, pm2]

- name: Setup PM2 startup script
  ansible.builtin.command: "pm2 startup systemd -u {{ nodejs_pm2_user }} --hp /home/{{ nodejs_pm2_user }}"
  when: 
    - nodejs_pm2_enabled | default(false) | bool
    - nodejs_pm2_user is defined
  tags: [nodejs, pm2]
