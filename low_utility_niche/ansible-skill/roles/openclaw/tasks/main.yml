---
# OpenClaw role - Install and configure OpenClaw

- name: Install OpenClaw globally
  community.general.npm:
    name: openclaw
    global: yes
    state: "{{ 'latest' if openclaw_version == 'latest' else 'present' }}"
    version: "{{ omit if openclaw_version == 'latest' else openclaw_version }}"
  tags: [openclaw]

- name: Verify OpenClaw installation
  ansible.builtin.command: openclaw --version
  register: openclaw_installed_version
  changed_when: false
  failed_when: false
  tags: [openclaw]

- name: Display OpenClaw version
  ansible.builtin.debug:
    msg: "OpenClaw {{ openclaw_installed_version.stdout | default('not installed') }}"
  tags: [openclaw]

# === Config Directory ===
- name: Create OpenClaw config directory
  ansible.builtin.file:
    path: "{{ openclaw_config_dir }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0700'
  tags: [openclaw, config]

- name: Create OpenClaw workspace directory
  ansible.builtin.file:
    path: "{{ openclaw_workspace }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'
  when: openclaw_workspace is defined
  tags: [openclaw, config]

# === Systemd Service ===
- name: Create OpenClaw systemd service
  ansible.builtin.template:
    src: openclaw.service.j2
    dest: /etc/systemd/system/openclaw.service
    mode: '0644'
  notify: Reload systemd
  tags: [openclaw, systemd]

- name: Enable OpenClaw service
  ansible.builtin.systemd:
    name: openclaw
    enabled: yes
  when: openclaw_service_enabled | default(false) | bool
  tags: [openclaw, systemd]

- name: Start OpenClaw service
  ansible.builtin.systemd:
    name: openclaw
    state: started
  when: 
    - openclaw_service_enabled | default(false) | bool
    - openclaw_service_started | default(false) | bool
  tags: [openclaw, systemd]

# === Post-install Notes ===
- name: Check if OpenClaw is configured
  ansible.builtin.stat:
    path: "{{ openclaw_config_dir }}/config.json"
  register: openclaw_config_exists
  tags: [openclaw]

- name: Display setup instructions
  ansible.builtin.debug:
    msg: |
      
      ╔══════════════════════════════════════════════════════════════════╗
      ║                    OpenClaw Installation Complete                 ║
      ╠══════════════════════════════════════════════════════════════════╣
      ║                                                                  ║
      ║  Next Steps:                                                     ║
      ║  1. SSH to server: ssh {{ openclaw_user }}@{{ ansible_host }}
      ║  2. Initialize:    openclaw init                                 ║
      ║  3. Configure API keys and channels                              ║
      ║  4. Enable service: sudo systemctl enable --now openclaw         ║
      ║                                                                  ║
      ║  Config location: {{ openclaw_config_dir }}
      ║  Workspace: {{ openclaw_workspace | default('~/' + openclaw_user + '/clawd') }}
      ║                                                                  ║
      ╚══════════════════════════════════════════════════════════════════╝
  when: not openclaw_config_exists.stat.exists
  tags: [openclaw]
